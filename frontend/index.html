<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management System</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        header { background: #fff; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        header h1 { color: #333; font-size: 24px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info span { color: #666; }
        
        /* Buttons */
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover { background: #545b62; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; color: #fff; }
        
        /* Cards */
        .card { background: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { margin-bottom: 15px; color: #333; }
        
        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-group input:focus { outline: none; border-color: #007bff; }
        
        /* Auth Forms */
        .auth-container { max-width: 400px; margin: 50px auto; }
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .auth-tabs button { flex: 1; }
        .auth-tabs button.active { background: #007bff; }
        
        /* Orders */
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .order-card { background: #fff; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .order-card .order-id { font-size: 12px; color: #888; margin-bottom: 5px; }
        .order-card .order-status { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; margin-bottom: 10px; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-validated { background: #cce5ff; color: #004085; }
        .status-payment_processed { background: #d4edda; color: #155724; }
        .status-fulfilled { background: #d1ecf1; color: #0c5460; }
        .status-shipped { background: #e2e3e5; color: #383d41; }
        .status-delivered { background: #28a745; color: #fff; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .order-card .order-items { margin: 10px 0; font-size: 14px; }
        .order-card .order-total { font-weight: bold; font-size: 18px; color: #333; }
        .order-card .order-date { font-size: 12px; color: #888; }
        
        /* Items Table */
        .items-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .items-table th, .items-table td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
        .items-table th { background: #f8f9fa; font-weight: 500; }
        
        /* Notifications */
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 6px; color: #fff; z-index: 1000; animation: slideIn 0.3s ease; }
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        /* WebSocket Status */
        .ws-status { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .ws-dot { width: 8px; height: 8px; border-radius: 50%; }
        .ws-connected { background: #28a745; }
        .ws-disconnected { background: #dc3545; }
        
        /* Sections */
        .section { display: none; }
        .section.active { display: block; }
        
        /* Loading */
        .loading { text-align: center; padding: 20px; color: #666; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
        
        .item-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .item-row input { flex: 1; }
    </style>
</head>
<body>
    <header>
        <h1>Order Management</h1>
        <div class="user-info" id="userInfo">
            <div class="ws-status">
                <div class="ws-dot" id="wsDot"></div>
                <span id="wsStatus">Disconnected</span>
            </div>
            <button class="btn-secondary" onclick="showSection('orders')">My Orders</button>
            <button class="btn-primary" onclick="openCreateOrderModal()">New Order</button>
            <button class="btn-danger" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="container">
        <!-- Auth Section -->
        <div id="authSection" class="section">
            <div class="auth-container">
                <div class="card">
                    <div class="auth-tabs">
                        <button class="btn-primary active" onclick="showAuthTab('login')" id="loginTab">Login</button>
                        <button class="btn-secondary" onclick="showAuthTab('register')" id="registerTab">Register</button>
                    </div>
                    
                    <!-- Login Form -->
                    <div id="loginForm">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="loginEmail" placeholder="Enter email">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" placeholder="Enter password">
                        </div>
                        <button class="btn-primary" onclick="login()" style="width: 100%">Login</button>
                    </div>
                    
                    <!-- Register Form -->
                    <div id="registerForm" style="display: none;">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="regEmail" placeholder="Enter email">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="regPassword" placeholder="Enter password">
                        </div>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="regFullName" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="text" id="regPhone" placeholder="Enter phone">
                        </div>
                        <button class="btn-primary" onclick="register()" style="width: 100%">Register</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="ordersSection" class="section">
            <div class="card">
                <h2>My Orders</h2>
                <div id="ordersList" class="orders-grid"></div>
            </div>
        </div>
    </div>

    <!-- Create Order Modal -->
    <div class="modal" id="createOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Order</h3>
                <button class="modal-close" onclick="closeCreateOrderModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Items</label>
                <div id="orderItems">
                    <div class="item-row">
                        <input type="text" placeholder="Product ID" class="item-product-id">
                        <input type="number" placeholder="Quantity" class="item-quantity" value="1" min="1">
                        <input type="number" placeholder="Unit Price" class="item-price" step="0.01" value="10.00">
                    </div>
                </div>
                <button class="btn-secondary" onclick="addItemRow()" style="margin-top: 10px;">+ Add Item</button>
            </div>
            <div class="form-group">
                <label>Total Amount</label>
                <input type="number" id="orderTotal" step="0.01" value="10.00">
            </div>
            <div class="form-group">
                <label>Street</label>
                <input type="text" id="shippingStreet" placeholder="Street address">
            </div>
            <div class="form-group">
                <label>City</label>
                <input type="text" id="shippingCity" placeholder="City">
            </div>
            <div class="form-group">
                <label>State</label>
                <input type="text" id="shippingState" placeholder="State">
            </div>
            <div class="form-group">
                <label>ZIP Code</label>
                <input type="text" id="shippingZip" placeholder="ZIP code">
            </div>
            <div class="form-group">
                <label>Payment Method</label>
                <select id="paymentMethod">
                    <option value="CREDIT_CARD">Credit Card</option>
                    <option value="DEBIT_CARD">Debit Card</option>
                    <option value="PAYPAL">PayPal</option>
                </select>
            </div>
            <button class="btn-success" onclick="createOrder()" style="width: 100%">Create Order</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api/v1';
        let token = localStorage.getItem('access_token');
        let userId = localStorage.getItem('user_id');
        let ws = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (token) {
                showSection('orders');
                loadOrders();
                connectWebSocket();
            } else {
                showSection('auth');
            }
        });

        // Section Management
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section + 'Section').classList.add('active');
        }

        function showAuthTab(tab) {
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
            document.getElementById('loginTab').className = tab === 'login' ? 'btn-primary active' : 'btn-secondary';
            document.getElementById('registerTab').className = tab === 'register' ? 'btn-primary active' : 'btn-secondary';
        }

        // Notifications
        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        // Auth Functions
        async function register() {
            const data = {
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                full_name: document.getElementById('regFullName').value,
                phone: document.getElementById('regPhone').value
            };
            
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Registration failed');
                showNotification('Registration successful! Please login.', 'success');
                showAuthTab('login');
            } catch (e) {
                showNotification(e.message, 'error');
            }
        }

        async function login() {
            const data = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            };
            
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Invalid credentials');
                
                const tokens = await res.json();
                token = tokens.access_token;
                localStorage.setItem('access_token', token);
                
                // Decode JWT to get user_id
                const payload = JSON.parse(atob(token.split('.')[1]));
                userId = payload.sub;
                localStorage.setItem('user_id', userId);
                
                showNotification('Login successful!', 'success');
                showSection('orders');
                loadOrders();
                connectWebSocket();
            } catch (e) {
                showNotification(e.message, 'error');
            }
        }

        function logout() {
            token = null;
            userId = null;
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_id');
            if (ws) ws.close();
            showSection('auth');
            showNotification('Logged out', 'info');
        }

        // Orders Functions
        async function loadOrders() {
            try {
                const res = await fetch(`${API_URL}/orders?user_id=${userId}&page=1&page_size=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                displayOrders(data.orders || []);
            } catch (e) {
                console.error('Failed to load orders:', e);
            }
        }

        function displayOrders(orders) {
            const container = document.getElementById('ordersList');
            if (orders.length === 0) {
                container.innerHTML = '<p style="color: #666;">No orders yet. Create your first order!</p>';
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-id">Order #${order.order_id.slice(0, 8)}</div>
                    <span class="order-status status-${order.status}">${order.status}</span>
                    <div class="order-items">
                        <table class="items-table">
                            <tr><th>Product</th><th>Qty</th><th>Price</th></tr>
                            ${order.items.map(item => `
                                <tr>
                                    <td>${item.product_id}</td>
                                    <td>${item.quantity}</td>
                                    <td>$${item.unit_price}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                    <div class="order-total">$${order.total_amount}</div>
                    <div class="order-date">${new Date(order.created_at).toLocaleString()}</div>
                </div>
            `).join('');
        }

        // Create Order Modal
        function openCreateOrderModal() {
            document.getElementById('createOrderModal').classList.add('active');
        }

        function closeCreateOrderModal() {
            document.getElementById('createOrderModal').classList.remove('active');
        }

        function addItemRow() {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <input type="text" placeholder="Product ID" class="item-product-id">
                <input type="number" placeholder="Quantity" class="item-quantity" value="1" min="1">
                <input type="number" placeholder="Unit Price" class="item-price" step="0.01" value="10.00">
            `;
            document.getElementById('orderItems').appendChild(div);
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                total += qty * price;
            });
            document.getElementById('orderTotal').value = total.toFixed(2);
        }

        async function createOrder() {
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                items.push({
                    product_id: row.querySelector('.item-product-id').value || 'prod-001',
                    quantity: parseInt(row.querySelector('.item-quantity').value) || 1,
                    unit_price: parseFloat(row.querySelector('.item-price').value) || 10
                });
            });

            const data = {
                user_id: userId,
                items: items,
                total_amount: parseFloat(document.getElementById('orderTotal').value),
                shipping_address: {
                    street: document.getElementById('shippingStreet').value,
                    city: document.getElementById('shippingCity').value,
                    state: document.getElementById('shippingState').value,
                    zip: document.getElementById('shippingZip').value,
                    country: 'US'
                },
                payment_method: document.getElementById('paymentMethod').value
            };

            try {
                const res = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Failed to create order');
                
                const order = await res.json();
                showNotification('Order created successfully!', 'success');
                closeCreateOrderModal();
                loadOrders();
            } catch (e) {
                showNotification(e.message, 'error');
            }
        }

        // WebSocket
        function connectWebSocket() {
            if (ws) ws.close();
            
            ws = new WebSocket('ws://localhost:8001/ws/');
            
            ws.onopen = () => {
                document.getElementById('wsDot').className = 'ws-dot ws-connected';
                document.getElementById('wsStatus').textContent = 'Connected';
            };
            
            ws.onclose = () => {
                document.getElementById('wsDot').className = 'ws-dot ws-disconnected';
                document.getElementById('wsStatus').textContent = 'Disconnected';
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    showNotification(`Order #${data.order_id?.slice(0,8)}: ${data.event_type}`, 'info');
                    loadOrders();
                } catch (e) {}
            };
        }

        // Auto-calculate total on item changes
        document.getElementById('orderItems').addEventListener('input', calculateTotal);
    </script>
</body>
</html>
